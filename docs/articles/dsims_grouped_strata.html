<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Grouping strata during simulation • dsims</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Grouping strata during simulation">
<meta name="description" content="Estimation when combining strata for logistical or design reasons.
">
<meta property="og:description" content="Estimation when combining strata for logistical or design reasons.
">
<script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window, document, "clarity", "script", "m9ts0haeya");</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dsims</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.5.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Function reference</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/GettingStarted.html">Getting started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/dsims-examples.html">Transition from `DSsim` to `dsims`</a></li>
    <li><a class="dropdown-item" href="../articles/dsims_grouped_strata.html">Grouped strata</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://twitter.com/distancesamp" aria-label="Twitter"><span class="fa fa-twitter"></span></a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DistanceDevelopment/dsims/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Grouping strata during simulation</h1>
                        <h4 data-toc-skip class="author">L. Marshall</h4>
            <address class="author_afil">
      CREEM, Univ of St Andrews<br><h4 data-toc-skip class="date">April 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DistanceDevelopment/dsims/blob/HEAD/vignettes/dsims_grouped_strata.Rmd" class="external-link"><code>vignettes/dsims_grouped_strata.Rmd</code></a></small>
      <div class="d-none name"><code>dsims_grouped_strata.Rmd</code></div>
    </address>
</div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DistanceDevelopment/dsims" class="external-link">dsims</a></span><span class="op">)</span></span></code></pre></div>
<p>These example simulations demonstrate the option to group strata at the analysis stage during a simulation. There are different reasons why we may wish to divide our study region into strata, or perhaps strata into sub strata, but sometimes we might need to create strata purely to optimise the design. For example, if we have a narrow study region that follows a coastline and we wish to keep our lines perpendicular to the coast then we may need to divide the region into strata and use different design angles in each stratum. Assuming we keep the coverage constant across these strata, the data can then be grouped at the analysis stage. We will illustrate an example of grouping strata at the analysis stage below.</p>
<div class="section level2">
<h2 id="getting-started">Getting started<a class="anchor" aria-label="anchor" href="#getting-started"></a>
</h2>
<p>Ensure you have administrator privileges on your computer and install the necessary R packages.</p>
<div class="section level3">
<h3 id="running-the-simulation-and-viewing-the-results-for-yourself">Running the simulation and viewing the results for yourself<a class="anchor" aria-label="anchor" href="#running-the-simulation-and-viewing-the-results-for-yourself"></a>
</h3>
<p>It is advisable to download the <a href="dsims_grouped_strata.Rmd">.Rmd</a> file if you would like to replicate the simulations for yourself. In addition, results from these simulations are provided to allow you to compile the .Rmd document. The results are included in a zip archive <a href="results.zip">results.zip</a>. Uncompressing the contents into a folder called results within the same folder as the .Rmd file should give you the required structure to run the code in the .Rmd file. You should end up with the file <em>sim.results.ROBJ</em> within the results folder.</p>
</div>
</div>
<div class="section level2">
<h2 id="creating-a-grouped-strata-simulation">Creating a grouped strata simulation<a class="anchor" aria-label="anchor" href="#creating-a-grouped-strata-simulation"></a>
</h2>
<div class="section level3">
<h3 id="creating-a-region-object">Creating a region object<a class="anchor" aria-label="anchor" href="#creating-a-region-object"></a>
</h3>
<p>First, we create the region object using a shapefile stored within the package directory. The shapefile provided contains a marine study area off the coast of Ireland. This region has already been projected into metres and <code>dssd</code> will detect that from the shapefile .prj file. The study region has also been divided into six strata and we will provide names in the code below to identify them (“North”, “NW”, “West Upper”, “West Lower”, “SW”, “South”). Care should be taken to check that the order of the strata is as expected by checking a plot of the study region.</p>
<p>The division of the study area into six strata was for design purposes, this allows us to specify design angles for each stratum individually. However, for analysis purposes we are interested in estimates for only two distinct areas in this study region, these will consist of the three northern strata grouped together and the three southern strata grouped together.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Find the full file path to the shapefile on the users machine</span></span>
<span><span class="va">shapefile.path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"AreaRProjStrata.shp"</span>, package <span class="op">=</span> <span class="st">"dssd"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the region object</span></span>
<span><span class="va">region</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dssd/man/make.region.html" class="external-link">make.region</a></span><span class="op">(</span>region.name <span class="op">=</span> <span class="st">"study area"</span>, strata.name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"North"</span>, <span class="st">"NW"</span>,</span>
<span>    <span class="st">"West Upper"</span>, <span class="st">"West Lower"</span>, <span class="st">"SW"</span>, <span class="st">"South"</span><span class="op">)</span>, shape <span class="op">=</span> <span class="va">shapefile.path</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the survey region</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsims_grouped_strata_files/figure-html/makereg-1.png"><!-- --></p>
</div>
<div class="section level3">
<h3 id="creating-a-design-object">Creating a design object<a class="anchor" aria-label="anchor" href="#creating-a-design-object"></a>
</h3>
<p>As mentioned above, we have two sub regions of interest in this study area, for which we would like estimates of density / abundance (the northern three strata and the southern three strata). Let’s start by constructing our design as though we had only divided our study region into two strata. We expect more animals in the southern strata so we will implement a non-uniform coverage design by allocating more effort per unit area (i.e. higher coverage) to this strata than the northern strata.</p>
<p>Let’s assume that our effort calculations have suggested that we have sufficient resources to survey parallel lines with a spacing of 16,000m in the northern strata and a spacing of 8,000m in the southern strata. Note that as our shapefile units are metres, all our simulation measurements must also be provided in metres. We will supply a single design angle for the three northern strata and one for the three southern strata, let’s set these to be 135 and 70 degrees, respectively. We will also specify that we will be doing minus sampling and do not expect to observe animals beyond 1,500m.</p>
<p>We will generate a set of transects from this design and assess them for desirable design qualities.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a design based on only two strata</span></span>
<span><span class="va">design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dssd/man/make.design.html" class="external-link">make.design</a></span><span class="op">(</span>region <span class="op">=</span> <span class="va">region</span>, transect.type <span class="op">=</span> <span class="st">"line"</span>, design <span class="op">=</span> <span class="st">"systematic"</span>,</span>
<span>    spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16000</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">8000</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, design.angle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">135</span>, <span class="fl">135</span>, <span class="fl">135</span>, <span class="fl">70</span>,</span>
<span>        <span class="fl">70</span>, <span class="fl">70</span><span class="op">)</span>, edge.protocol <span class="op">=</span> <span class="st">"minus"</span>, truncation <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate and plot a single set of transects</span></span>
<span><span class="va">survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dssd/man/generate.transects-methods.html" class="external-link">generate.transects</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">survey</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsims_grouped_strata_files/figure-html/design_one-1.png"><!-- --></p>
<p>An optimal design will aim to both maximise the number of samplers (many short lines are better than fewer long lines) and place them parallel to any density gradients. In the case of a long thin study region such as this, we want to lay the transects across the short dimension of the region (i.e. perpendicular to the coast). It is also often the case that marine species are distributed in relation to the coast (usually having a particular depth preference) so again laying the transects perpendicular to the coast should align them parallel to any density gradient and thereby reduce variability in encounter rate between transects resulting in more precise estimates.</p>
<p>We can see from this first design, given the complexity of the region, choosing a single design angle for the northern and southern groups of strata is not going to achieve this goal. This is particularly problematic in the southern strata where selecting a design angle to give lines perpendicular to the coast in one area gives lines that are parallel to the coast in another. We now make use of the fact that we have six strata and select appropriate design angles in each with the aim of orientating the transects so they are perpendicular to the coast.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the design</span></span>
<span><span class="va">design</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dssd/man/make.design.html" class="external-link">make.design</a></span><span class="op">(</span>region <span class="op">=</span> <span class="va">region</span>, transect.type <span class="op">=</span> <span class="st">"line"</span>, design <span class="op">=</span> <span class="st">"systematic"</span>,</span>
<span>    spacing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">16000</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">8000</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, design.angle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">160</span>, <span class="fl">135</span>, <span class="fl">80</span>, <span class="fl">135</span>,</span>
<span>        <span class="fl">50</span>, <span class="fl">150</span><span class="op">)</span>, edge.protocol <span class="op">=</span> <span class="st">"minus"</span>, truncation <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Create a single set of transects to check</span></span>
<span><span class="va">survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dssd/man/generate.transects-methods.html" class="external-link">generate.transects</a></span><span class="op">(</span><span class="va">design</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">region</span>, <span class="va">survey</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsims_grouped_strata_files/figure-html/design_two-1.png"><!-- --></p>
<p>We can see from the image above that further dividing the northern and southern regions of interest into substrata allows us to better orientate our lines to both maximise the number of samplers and place them perpendicular to the coast.</p>
<p>As this further stratification was purely for design purposes (so we could modify the design angle as we moved along the coast) we would still treat each of the three substrata as one when we come to analyse the data. However, it is important to note that we can only do this because we have kept a uniform coverage across the substrata. However, the above design would not allow us to simply group all 6 strata at the analysis stage. As the northern strata have lower coverage than the southern strata the full dataset will be more representative of the southern strata than the northern and we must therefore ensure that any differences in detectability are modelled.</p>
</div>
<div class="section level3">
<h3 id="creating-a-density-object">Creating a density object<a class="anchor" aria-label="anchor" href="#creating-a-density-object"></a>
</h3>
<p>We will create a density surface to represent a distribution of animals which is more abundant in the south and also prefers coastal waters.</p>
<p>In order to get an idea of where to place the hostpots we can first check the range of the coordinates on the projected scale. Note that the plot of the region gives the scale in lat and lon despite the region being projected. We can access this information by requesting the bounding box of the sf object stored within the <code>dssd</code> region.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the bounding box of the sf object within the region</span></span>
<span><span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">region</span><span class="op">@</span><span class="va">region</span><span class="op">)</span></span></code></pre></div>
<p>We can now create a density grid with a spacing of 2,500m in both dimensions and add two hotspots to simulate a potentially realistic distribution of animals which prefer to stick closely to the coast. Adding hotspots is largely done by trial and error once we know the range of the x-y coordinate values. Again all measurement values must be provided in metres. As we will later use a fixed population size in the simulations, we do not need to worry about the exact values we provide in the density grid only how they relate to one another. For example, an area with a density cell with a value twice that of another density cell will, on average, end up with twice as many animals when the population is generated.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make a density grid with values of 1 across the region</span></span>
<span><span class="va">my.density</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make.density.html">make.density</a></span><span class="op">(</span>region <span class="op">=</span> <span class="va">region</span>, x.space <span class="op">=</span> <span class="fl">2500</span>, y.space <span class="op">=</span> <span class="fl">2500</span>, constant <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a hotspot at coordinates (0, 1900000)</span></span>
<span><span class="va">my.density</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add.hotspot-methods.html">add.hotspot</a></span><span class="op">(</span><span class="va">my.density</span>, centre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1900000</span><span class="op">)</span>, sigma <span class="op">=</span> <span class="fl">70000</span>, amplitude <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add a hotspot at coordinates (80000, 210000)</span></span>
<span><span class="va">my.density</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add.hotspot-methods.html">add.hotspot</a></span><span class="op">(</span><span class="va">my.density</span>, centre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">80000</span>, <span class="fl">2100000</span><span class="op">)</span>, sigma <span class="op">=</span> <span class="fl">1e+05</span>,</span>
<span>    amplitude <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot this example density surface</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">my.density</span>, <span class="va">region</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsims_grouped_strata_files/figure-html/density-1.png"><!-- --></p>
<div class="section level4">
<h4 id="population-size">Population size<a class="anchor" aria-label="anchor" href="#population-size"></a>
</h4>
<p>We will base our simulation on a total population size of 2,500 animals. As the make.population command requires us to specify how many individuals per stratum, we will have to calculate this using the density summary.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># View the density summary</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">my.density</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       strata             area       ave.N    ave.D</span></span>
<span><span class="co">## 1      North 4176461143 [m^2]  8731625315 2.090676</span></span>
<span><span class="co">## 2         NW 8180996497 [m^2] 25656220203 3.136075</span></span>
<span><span class="co">## 3 West Upper 6316380968 [m^2] 17438152704 2.760782</span></span>
<span><span class="co">## 4 West Lower 8188111047 [m^2] 41315196625 5.045754</span></span>
<span><span class="co">## 5         SW 2654685511 [m^2] 13585880563 5.117699</span></span>
<span><span class="co">## 6      South 9291229356 [m^2] 48534037861 5.223640</span></span></code></pre>
<p>We can see from the table that if we used the exact densities in the density grid we would generate a lot of animals (see ave.N column)! However, as mentioned above, the simulation will only use this density surface as a guide to relative density across the region. Therefore, we will use these value to decide how many animals to allocate to each strata by scaling them.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract average N values</span></span>
<span><span class="va">ave.N.vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">my.density</span><span class="op">)</span><span class="op">@</span><span class="va">summary</span><span class="op">$</span><span class="va">ave.N</span></span>
<span><span class="co"># Scale average N vals to sum to 2500</span></span>
<span><span class="va">N.per.stratum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">2500</span> <span class="op">*</span> <span class="va">ave.N.vals</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ave.N.vals</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the allocation per stratum</span></span>
<span><span class="va">N.per.stratum</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 141 413 281 665 219 781</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check the total sums to 2500 (sometimes rounding may cause slight variation)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">N.per.stratum</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2500</span></span></code></pre>
<p>At this point, we will also create an individual level covariate to indicate whether the animals are in the northern group of strata or the southern group of strata. We will do this to enable us to later model any differences in detectability between the northern and southern sub populations. Ignoring any differences would not only lead bias in our estimates of abundance for the northern and southern strata but also in our total estimates due to the non-uniform coverage design.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the population description</span></span>
<span><span class="va">covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># Adds a strata group entry allocating 'North' to all animals in the North, NW</span></span>
<span><span class="co"># and West Upper strata and allocating 'South' to all animals in the West</span></span>
<span><span class="co"># Lower, SW and South strata.</span></span>
<span><span class="va">covs</span><span class="op">$</span><span class="va">strata.group</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>level <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"North"</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"South"</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,</span>
<span>    <span class="fl">6</span><span class="op">)</span>, strata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"North"</span>, <span class="st">"NW"</span>, <span class="st">"West Upper"</span>, <span class="st">"West Lower"</span>, <span class="st">"SW"</span>, <span class="st">"South"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We will now include the above information in our population description and set the fixed population size argument to be true.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the population description</span></span>
<span><span class="va">pop.description</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make.population.description.html">make.population.description</a></span><span class="op">(</span>region <span class="op">=</span> <span class="va">region</span>, density <span class="op">=</span> <span class="va">my.density</span>,</span>
<span>    covariates <span class="op">=</span> <span class="va">covs</span>, N <span class="op">=</span> <span class="va">N.per.stratum</span>, fixed.N <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="true-detection-function">True detection function<a class="anchor" aria-label="anchor" href="#true-detection-function"></a>
</h4>
<p>We will simulate using a half-normal detection function but change <span class="math inline">\(\sigma\)</span> (scale.param) depending on stratum and use a truncation distance of 1500m. By changing the detection functions across strata we can demonstrate when pooling robustness applies. Pooling robustness refers to a property in distance sampling which allows us to obtain unbiased abundance estimates from a single ‘pooled’ detection function fitted across a number of sub populations, even when detectability may vary greatly, <span class="citation">(Rexstad, Buckland, Marshall, &amp; Borchers, 2023)</span>. Pooling robustness applies when our data are a representative sample across the population for which we are generating estimates. In this example, the data in our three northern sub-strata can be pooled and the data in our three southern sub- strata can be pooled as these have the same coverage as each other. We cannot pool detections from any strata / sub-strata where coverage varies (without accounting for the non-uniform coverage) as the resulting detection function will be more representative of the strata with higher coverage.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the detectability</span></span>
<span><span class="va">detect</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make.detectability.html">make.detectability</a></span><span class="op">(</span>key.function <span class="op">=</span> <span class="st">"hn"</span>, scale.param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">950</span>, <span class="fl">850</span>, <span class="fl">750</span>,</span>
<span>    <span class="fl">650</span>, <span class="fl">550</span>, <span class="fl">450</span><span class="op">)</span>, truncation <span class="op">=</span> <span class="fl">1500</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the detectability</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">detect</span>, <span class="va">pop.description</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsims_grouped_strata_files/figure-html/truedetect-1.png"><!-- --></p>
</div>
</div>
<div class="section level3">
<h3 id="creating-the-analyses-object">Creating the analyses object<a class="anchor" aria-label="anchor" href="#creating-the-analyses-object"></a>
</h3>
<p>The simulation engine currently only fits one global detection function to each simulated dataset. In the scenario we have constructed, we know that pooling robustness does not apply across the study region as a whole as we have different levels of coverage between the northern and southern stratum groups. Given we cannot fit separate detection functions, we must allow our model to be able to vary the detection function across the two groups of strata. To achieve this we can include the <code>strata.group</code> covariate (which we included in the population description) in the model, this will allow a different scale parameter to be estimated for the northern three strata than for the southern three.</p>
<p>Note that we could have simply included <code>Region.Label</code> as a covariate in the detection function model, however, within the simulation at the stage of fitting the detection function all strata are included in the dataset and this would have resulted in a scale parameter being estimated for all 6 strata individually.</p>
<p>It is at the analysis stage that we also need to define how the strata will be grouped in order to obtain estimates for our regions of interest. The dataframe created in the code below tells the simulation how to group the strata.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a dataframe describing how the strata will be grouped</span></span>
<span><span class="va">group.strata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>design.id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"North"</span>, <span class="st">"NW"</span>, <span class="st">"West Upper"</span>, <span class="st">"West Lower"</span>,</span>
<span>    <span class="st">"SW"</span>, <span class="st">"South"</span><span class="op">)</span>, analysis.id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"North"</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"South"</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View the dataframe</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">group.strata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    design.id analysis.id</span></span>
<span><span class="co">## 1      North       North</span></span>
<span><span class="co">## 2         NW       North</span></span>
<span><span class="co">## 3 West Upper       North</span></span>
<span><span class="co">## 4 West Lower       South</span></span>
<span><span class="co">## 5         SW       South</span></span>
<span><span class="co">## 6      South       South</span></span></code></pre>
<p>We will now define the analyses. As we are simulating detections from a range of difference detection functions, we will incorporate some model uncertainty by allowing the simulation to select between a half normal and a hazard rate model. Both these models will include the strata.group covariate and we will use the AIC as the criterion for model selection.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the analyses - both the hn and hr models use the ~strata.group formula</span></span>
<span><span class="va">ds.analyses</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make.ds.analysis.html">make.ds.analysis</a></span><span class="op">(</span>dfmodel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span><span class="va">strata.group</span>, <span class="op">~</span><span class="va">strata.group</span><span class="op">)</span>, key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hn"</span>,</span>
<span>    <span class="st">"hr"</span><span class="op">)</span>, truncation <span class="op">=</span> <span class="fl">1500</span>, group.strata <span class="op">=</span> <span class="va">group.strata</span>, criteria <span class="op">=</span> <span class="st">"AIC"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-the-simulation">Running the simulation<a class="anchor" aria-label="anchor" href="#running-the-simulation"></a>
</h3>
<p>Before running the simulation we group all the components into a simulation object and define the number of repetitions. For this example we will simulate 1000 surveys from our simulation definition. Note that the first time you run a simulation you should limit the number of repetitions to only a few to check everything works as expected.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the simulation</span></span>
<span><span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make.simulation.html">make.simulation</a></span><span class="op">(</span>reps <span class="op">=</span> <span class="fl">1000</span>, design <span class="op">=</span> <span class="va">design</span>, population.description <span class="op">=</span> <span class="va">pop.description</span>,</span>
<span>    detectability <span class="op">=</span> <span class="va">detect</span>, ds.analysis <span class="op">=</span> <span class="va">ds.analyses</span><span class="op">)</span></span></code></pre></div>
<p>A useful way to check the simulation setup is to generate a single example survey, this may take a moment to complete.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate the data generation for a single survey</span></span>
<span><span class="va">eg.survey</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run.survey-methods.html">run.survey</a></span><span class="op">(</span><span class="va">simulation</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the example survey</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eg.survey</span>, <span class="va">region</span><span class="op">)</span></span></code></pre></div>
<p><img src="dsims_grouped_strata_files/figure-html/egsurvey-1.png"><!-- --></p>
<p>If the previous plots lead you to believe you have properly parameterised your simulation, it is time to run it. If you run it for a small number of repetitions it should only take a minute or two to complete, running for a 1000 repetitions will take considerably longer and so this simulation has already been run and the results can be loaded instead.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the simulation in parallel</span></span>
<span><span class="va">simulation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run.simulation-methods.html">run.simulation</a></span><span class="op">(</span><span class="va">simulation</span>, run.parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the simulation object which has already been run</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"files/sim.results.ROBJ"</span><span class="op">)</span></span></code></pre></div>
<p>After you have loaded the simulation with the results, you can view them. To view the full summary use <code>summary(simulation)</code>, below we will store the simulation summary and look at specific tables within it. Firstly, we will view the summary table. Notice that as requested we have results for only a northern and a southern strata instead of all six of the substrata. The summary table indicates that around 98 detections were made on average in the northern strata and 275 in the southern strata. It is important to check that there are sufficient detections in each strata so that any differences in detectability can be accurately modelled in the detection function.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a summary (silently without the description)</span></span>
<span><span class="va">sim.summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">simulation</span>, description.summary <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display the summary table</span></span>
<span><span class="va">sim.summary</span><span class="op">@</span><span class="va">individuals</span><span class="op">$</span><span class="va">summary</span></span></code></pre></div>
<pre><code><span><span class="co">##       mean.Cover.Area mean.Effort  mean.n mean.k      mean.ER   mean.se.ER</span></span>
<span><span class="co">## North      3498729895     1166243  98.490 27.912 8.445558e-05 9.150347e-06</span></span>
<span><span class="co">## South      7551517574     2517173 274.998 71.931 1.092477e-04 7.244126e-06</span></span>
<span><span class="co">## Total     11050247469     3683416 373.488 99.843 9.731804e-05 5.812492e-06</span></span>
<span><span class="co">##         sd.mean.ER</span></span>
<span><span class="co">## North 7.782846e-06</span></span>
<span><span class="co">## South 5.842293e-06</span></span>
<span><span class="co">## Total 4.780433e-06</span></span></code></pre>
<p>Next we will view the table giving the abundance estimates. There is only a small amount of negative bias for both strata and in the total estimate of abundance. However, the coverage of the confidence intervals (which should be 0.95) is only 0.92 for the southern strata and the total estimate. Sometimes reduced confidence interval coverage can be due to the variance being under estimated but in this case the mean.se (mean of the estimated standard error) and the sd.of.means (truth - observed standard error of the estimates) are very close suggesting the variance has been estimated accurately.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Display the table of abundance estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">sim.summary</span><span class="op">@</span><span class="va">individuals</span><span class="op">$</span><span class="va">N</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##       Truth mean.Estimate percent.bias    RMSE CI.coverage.prob mean.se</span></span>
<span><span class="co">## North   835       819.344       -1.875 111.016            0.956 115.122</span></span>
<span><span class="co">## South  1665      1604.102       -3.658 145.372            0.924 132.674</span></span>
<span><span class="co">## Total  2500      2423.446       -3.062 193.676            0.915 176.878</span></span>
<span><span class="co">##       sd.of.means</span></span>
<span><span class="co">## North     109.962</span></span>
<span><span class="co">## South     132.068</span></span>
<span><span class="co">## Total     177.993</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="discussion">Discussion<a class="anchor" aria-label="anchor" href="#discussion"></a>
</h3>
<p>Even though the detectability of animals was varied across each of the six sub-strata, the estimates for the northern and southern groups of sub-strata combined had very low bias. This result was due to pooling robustness applying across both these groups of sub strata (coverage was the same in each group). Meanwhile, the difference in detectability between the northern and southern groups was modelled explicitly using the strata.group covariate in each of the models. If the simulation was repeated, but this covariate was omitted, we would expect to see bias in the abundance estimated for the northern and southern regions as well as the overall estimate. This would be due to the differences in coverage between the three northen sub-strata and the three southern sub-strata and the fitted detection function being more representative of the southern region (due to the higher coverage) than the northern region.</p>
<p>The setup for the analysis in this simulation is a little complex due to the restrictions of the simulation package (i.e. needing to include the stratum covariate in the population description). When analysing your own distance sampling data from the field, if you have a similar scenario, you will be able to either fit separate detection functions to the data from the different regions of interest or create any kind of stratum variable you want, giving you more analysis options.</p>
</div>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0" line-spacing="2">
<div id="ref-Rexstad2013" class="csl-entry">
Rexstad, E., Buckland, S., Marshall, L., &amp; Borchers, D. (2023). Pooling robustness in distance sampling: Avoiding bias when there is unmodelled heterogeneity. <em>Ecology and Evolution</em>, <em>13</em>(1), e9684. Retrieved from<a href="https://onlinelibrary.wiley.com/doi/10.1002/ece3.9684" class="external-link">https://onlinelibrary.wiley.com/doi/10.1002/ece3.9684</a>
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>We improve our site and software support by using Microsoft Clarity to see <br> how you use our website. By using our site, you agree that we and Microsoft <br> can collect and use this data. Clarity is GDPR compliant.</p>
</div>

<div class="pkgdown-footer-right">
  <p>If you wish to donate to development and maintenance, please <a href="mailto:distance@st-andrews.ac.uk">email us</a>.</p>
</div>

    </footer>
</div>





  </body>
</html>
